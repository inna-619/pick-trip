<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¾æ—… PickTrip</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            background-color: #F9F9F7; /* è«è˜­è¿ªç±³ç™½èƒŒæ™¯ */
            color: #4A5D5E; /* æ·±ç°è—æ–‡å­— */
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif; }
        
        /* Modal å‹•ç•« */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body class="select-none md:select-auto">
    
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ğŸŸ¢ å·²å…§å»ºæ‚¨çš„ Firebase Config
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA4D3SuP0s3H9MGbJw8vS_TbuBv-uvl9Q8",
            authDomain: "inna-s-travel-plan.firebaseapp.com",
            projectId: "inna-s-travel-plan",
            storageBucket: "inna-s-travel-plan.firebasestorage.app",
            messagingSenderId: "919903302660",
            appId: "1:919903302660:web:dd02cafe552dc645043151", 
            measurementId: "G-HRMCMPFYXV"
        };

        // --- åˆå§‹åŒ– Firebase ---
        let db = null;
        let auth = null;
        let isOnline = false;

        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
                isOnline = true;
            }
        } catch (e) {
            console.error("Firebase Init Failed:", e);
            isOnline = false;
        }

        // --- Icon Components ---
        const IconBase = ({ children, size = 24, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        
        const Icons = {
            Home: (p) => <IconBase {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>,
            Briefcase: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>,
            MapIcon: (p) => <IconBase {...p}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></IconBase>,
            DollarSign: (p) => <IconBase {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            Sun: (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>,
            Calculator: (p) => <IconBase {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>,
            CheckSquare: (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>,
            Square: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></IconBase>,
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            Trash: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            Utensils: (p) => <IconBase {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>,
            Bed: (p) => <IconBase {...p}><path d="M2 8v16"/><path d="M2 20h20"/><path d="M22 8v16"/><path d="M12 18v-7"/><path d="M12 8h10v7"/><path d="M2 8h10v7"/><path d="M5 8V4a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v4"/></IconBase>,
            Bus: (p) => <IconBase {...p}><path d="M8 6v6"/><path d="M15 6v6"/><path d="M2 12h19.6"/><path d="M18 21v-2a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v2"/><path d="M21 15V6a5 5 0 0 0-5-5H8a5 5 0 0 0-5 5v9"/><path d="M2 15h20"/><path d="M6 21v-2"/><path d="M18 21v-2"/></IconBase>,
            Wallet: (p) => <IconBase {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconBase>,
            MapPin: (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Grip: (p) => <IconBase {...p}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>,
            Loader: (p) => <IconBase {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
            Share: (p) => <IconBase {...p}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            WifiOff: (p) => <IconBase {...p}><line x1="1" x2="23" y1="1" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></IconBase>,
            Wifi: (p) => <IconBase {...p}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></IconBase>,
            Flag: (p) => <IconBase {...p}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></IconBase>,
            Plane: (p) => <IconBase {...p}><path d="M2 12h5"/><path d="M13 12h3"/><path d="M9.74 2.74 2 12h5l2.74-9.26a1 1 0 1 1 1.9 0.6Z"/><path d="M9.74 21.26 2 12h5l2.74 9.26a1 1 0 1 0 1.9-0.6Z"/><path d="M20 12h2"/></IconBase>,
            Edit: (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></IconBase>,
            Copy: (p) => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>
        };

        const { Home, Briefcase, MapIcon, DollarSign, Sun, Calculator, CheckSquare, Square, Plus, Trash, Utensils, Bed, Bus, Wallet, MapPin, Grip, Loader, Share, Users, WifiOff, Wifi, Flag, Plane, Edit, X, Copy } = Icons;
        const { useState, useEffect, useMemo, useRef } = React;

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const addDays = (date, days) => {
            if (!date) return new Date().toISOString().split('T')[0];
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result.toISOString().split('T')[0];
        };

        const INITIAL_DATA = {
            title: "æˆ‘çš„æ—…ç¨‹",
            startDate: new Date().toISOString().split('T')[0],
            travelers: ["æˆ‘"],
            info: { 
                weatherCity: "æ±äº¬", 
                travelMonth: "1", 
                weatherTemp: "5Â°C - 10Â°C", 
                weatherNote: "æ—©æ™šæº«å·®å¤§", 
                currencyRate: 0.21, 
                currencyCode: "JPY", 
                noteCards: [
                    { id: 'default1', title: 'èˆªç­è³‡è¨Š', content: 'å»ç¨‹: BR198 08:50\nå›ç¨‹: BR197 14:00' }
                ]
            },
            packing: { clothing: [], supplies: [], electronics: [], docs: [] },
            days: [{ id: 1, date: new Date().toISOString().split('T')[0], items: [] }]
        };

        const PACKING_CATEGORIES = {
            clothing: { label: "è¡£ç‰©é‹å¸½", color: "bg-[#F0D9D9] text-[#A67575]" },
            supplies: { label: "æ—¥ç”¨å“/è—¥å“", color: "bg-[#C6D6C8] text-[#557358]" },
            electronics: { label: "3C/é›»å™¨", color: "bg-[#DCE5E8] text-[#6B8594]" },
            docs: { label: "è­‰ä»¶/ç¾é‡‘", color: "bg-[#EBE1D0] text-[#8C7654]" }
        };

        const ITEM_TYPES = {
            attraction: { label: 'æ™¯é»', icon: MapPin, color: 'bg-[#E6C6C6] text-[#8A5A5A]' },
            activity: { label: 'æ´»å‹•', icon: Flag, color: 'bg-[#E6E0C6] text-[#8A855A]' },
            meal: { label: 'é¤é£²', icon: Utensils, color: 'bg-[#EED8C8] text-[#9C6849]' },
            accommodation: { label: 'ä½å®¿', icon: Bed, color: 'bg-[#D2D2E0] text-[#5D5D78]' },
            transport: { label: 'äº¤é€š', icon: Bus, color: 'bg-[#C3D9D1] text-[#4F7066]' },
            flight: { label: 'èˆªç­', icon: Plane, color: 'bg-[#D0E0E3] text-[#5A7D82]' },
            other: { label: 'å…¶ä»–', icon: Wallet, color: 'bg-[#E0E0E0] text-[#757575]' }
        };

        const MOCK_WEATHER_DATA = {
            "æ±äº¬": ["5Â°C-10Â°C", "6Â°C-11Â°C", "9Â°C-14Â°C", "14Â°C-19Â°C", "18Â°C-23Â°C", "21Â°C-26Â°C", "25Â°C-29Â°C", "26Â°C-31Â°C", "23Â°C-27Â°C", "18Â°C-22Â°C", "12Â°C-17Â°C", "8Â°C-12Â°C"],
            "å¤§é˜ª": ["6Â°C-10Â°C", "6Â°C-11Â°C", "9Â°C-14Â°C", "15Â°C-20Â°C", "20Â°C-25Â°C", "23Â°C-28Â°C", "27Â°C-32Â°C", "28Â°C-33Â°C", "24Â°C-29Â°C", "18Â°C-23Â°C", "13Â°C-17Â°C", "8Â°C-12Â°C"],
            "é¦–çˆ¾": ["-6Â°C-2Â°C", "-3Â°C-5Â°C", "2Â°C-10Â°C", "8Â°C-18Â°C", "13Â°C-23Â°C", "18Â°C-27Â°C", "22Â°C-29Â°C", "22Â°C-30Â°C", "17Â°C-26Â°C", "10Â°C-20Â°C", "3Â°C-12Â°C", "-4Â°C-4Â°C"],
            "å°åŒ—": ["14Â°C-19Â°C", "15Â°C-20Â°C", "17Â°C-22Â°C", "20Â°C-26Â°C", "23Â°C-29Â°C", "26Â°C-32Â°C", "28Â°C-34Â°C", "28Â°C-34Â°C", "26Â°C-31Â°C", "23Â°C-28Â°C", "20Â°C-25Â°C", "16Â°C-21Â°C"],
            "æ›¼è°·": ["22Â°C-32Â°C", "24Â°C-33Â°C", "26Â°C-34Â°C", "27Â°C-35Â°C", "26Â°C-34Â°C", "26Â°C-33Â°C", "26Â°C-33Â°C", "26Â°C-33Â°C", "25Â°C-32Â°C", "25Â°C-32Â°C", "24Â°C-32Â°C", "22Â°C-31Â°C"],
            "å€«æ•¦": ["2Â°C-8Â°C", "2Â°C-9Â°C", "4Â°C-12Â°C", "6Â°C-15Â°C", "9Â°C-18Â°C", "12Â°C-21Â°C", "14Â°C-23Â°C", "14Â°C-23Â°C", "11Â°C-20Â°C", "9Â°C-16Â°C", "5Â°C-11Â°C", "3Â°C-9Â°C"]
        };

        // --- ğŸŸ¢ é€šç”¨å°è©±æ¡†å…ƒä»¶ (è§£æ±º prompt/alert è¢«å°é–å•é¡Œ) ---
        const Modal = ({ isOpen, onClose, title, children, showConfirm, onConfirm, confirmText = "ç¢ºå®š", showCancel = true }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden transform transition-all relative z-10 animate-[modal-enter_0.2s_ease-out]">
                        <div className="bg-[#F4F8F7] p-4 flex justify-between items-center border-b border-[#E0E0E0]">
                            <h3 className="font-bold text-[#5A7D82]">{title}</h3>
                            <button onClick={onClose} className="text-[#9DAAB0] hover:text-[#A67575]"><X size={20}/></button>
                        </div>
                        <div className="p-4">
                            {children}
                        </div>
                        {(showConfirm || showCancel) && (
                            <div className="p-4 bg-[#F9F9F7] flex justify-end gap-2">
                                {showCancel && <button onClick={onClose} className="px-4 py-2 rounded-lg text-[#586666] hover:bg-[#E0E0E0] text-sm">å–æ¶ˆ</button>}
                                {showConfirm && <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-[#84A59D] text-white hover:bg-[#6B8E8E] text-sm font-bold shadow-sm">{confirmText}</button>}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- ğŸŸ¢ ç°¡æ˜“æç¤ºæ¡† (Toast) ---
        const Toast = ({ msg, show }) => {
            if (!show) return null;
            return (
                <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-[#4A5D5E] text-white px-4 py-2 rounded-full shadow-lg text-sm z-[60] flex items-center gap-2 animate-bounce">
                    <CheckSquare size={16}/> {msg}
                </div>
            );
        };

        // --- å­å…ƒä»¶ ---
        const InfoTab = ({ data, updateData, showModal }) => { // Pass showModal
            const [amount, setAmount] = useState(1000);
            const [rateLoading, setRateLoading] = useState(false);
            
            const updateWeather = (city, monthStr) => {
                const month = parseInt(monthStr);
                if (!city || !month) return;
                
                let temp = "";
                const cityKey = Object.keys(MOCK_WEATHER_DATA).find(k => city.includes(k));
                if (cityKey) {
                    temp = MOCK_WEATHER_DATA[cityKey][month - 1];
                } else {
                    if (month >= 6 && month <= 8) temp = "25Â°C - 30Â°C (é ä¼°)";
                    else if (month >= 12 || month <= 2) temp = "5Â°C - 12Â°C (é ä¼°)";
                    else temp = "15Â°C - 22Â°C (é ä¼°)";
                }
                updateData('info', { ...data.info, weatherCity: city, travelMonth: monthStr, weatherTemp: temp });
            };

            const fetchRate = async (code) => {
                if(!code || code.length !== 3) return;
                setRateLoading(true);
                try {
                    const res = await fetch(`https://open.er-api.com/v6/latest/${code.toUpperCase()}`);
                    const json = await res.json();
                    if (json && json.rates && json.rates.TWD) {
                        const rate = parseFloat(json.rates.TWD.toFixed(2));
                        updateData('info', { ...data.info, currencyCode: code.toUpperCase(), currencyRate: rate });
                    }
                } catch(e) {
                    console.error("Rate fetch failed", e);
                } finally {
                    setRateLoading(false);
                }
            };

            const handleAddNote = () => {
                showModal({
                    type: 'input',
                    title: 'æ–°å¢ç­†è¨˜',
                    message: 'è«‹è¼¸å…¥ç­†è¨˜æ¨™é¡Œ (ä¾‹å¦‚: è³¼ç‰©æ¸…å–®)',
                    defaultValue: 'æ–°ç­†è¨˜',
                    onConfirm: (val) => {
                        if(!val) return;
                        const newCard = { id: generateId(), title: val, content: "" };
                        const currentCards = data.info.noteCards || [];
                        updateData('info', { ...data.info, noteCards: [...currentCards, newCard] });
                    }
                });
            };

            const updateNoteContent = (id, newContent) => {
                const currentCards = data.info.noteCards || [];
                const newCards = currentCards.map(c => c.id === id ? { ...c, content: newContent } : c);
                updateData('info', { ...data.info, noteCards: newCards });
            };

            const handleDeleteNote = (id) => {
                showModal({
                    type: 'confirm',
                    title: 'åˆªé™¤ç­†è¨˜',
                    message: 'ç¢ºå®šè¦åˆªé™¤é€™å¼µç­†è¨˜å¡ç‰‡å—ï¼Ÿ',
                    onConfirm: () => {
                        const currentCards = data.info.noteCards || [];
                        const newCards = currentCards.filter(c => c.id !== id);
                        updateData('info', { ...data.info, noteCards: newCards });
                    }
                });
            };

            return (
                <div className="space-y-4 p-4 pb-24">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-[#F2E6D8]">
                        <h3 className="flex items-center gap-2 text-[#9C7A60] font-bold mb-3"><Sun size={20}/> å¤©æ°£æ¦‚æ³</h3>
                        <div className="flex gap-2 mb-2 items-center">
                            <input className="border-b border-[#F2E6D8] p-1 w-1/3 text-lg font-bold text-[#6D5D50] placeholder-[#D0C0B0] outline-none" 
                                value={data.info.weatherCity} 
                                onChange={e => updateWeather(e.target.value, data.info.travelMonth)} 
                                placeholder="åŸå¸‚ (å¦‚:æ±äº¬)" />
                            
                            <select className="border-b border-[#F2E6D8] p-1 text-sm text-[#8C7C6D] bg-transparent outline-none"
                                value={data.info.travelMonth}
                                onChange={e => updateWeather(data.info.weatherCity, e.target.value)}>
                                {[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}æœˆ</option>)}
                            </select>

                            <div className="flex-1 text-right">
                                <span className="text-xl font-bold text-[#9C7A60]">{data.info.weatherTemp || "--"}</span>
                            </div>
                        </div>
                        <input className="w-full border-b border-[#F2E6D8] p-1 text-sm text-[#8C7C6D] placeholder-[#D0C0B0] outline-none" 
                            value={data.info.weatherNote} onChange={e => updateData('info', { ...data.info, weatherNote: e.target.value })} placeholder="å¤©æ°£å‚™è¨»" />
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-[#DCE5E8]">
                        <h3 className="flex items-center gap-2 text-[#6B8594] font-bold mb-3"><Calculator size={20}/> åŒ¯ç‡è©¦ç®—</h3>
                        <div className="flex items-center gap-2 mb-4 bg-[#F4F7F8] p-2 rounded-lg text-[#58707E]">
                            <span className="text-sm">1</span>
                            <input className="w-16 bg-transparent border-b border-[#D0D9DE] text-center font-mono uppercase" 
                                value={data.info.currencyCode} 
                                onBlur={e => fetchRate(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && fetchRate(data.info.currencyCode)}
                                onChange={e => updateData('info', { ...data.info, currencyCode: e.target.value })} />
                            <span className="text-sm">=</span>
                            <div className="relative">
                                <input type="number" className="w-20 bg-white border border-[#D0D9DE] rounded px-1 text-center font-bold text-[#58707E]" 
                                    value={data.info.currencyRate} onChange={e => updateData('info', { ...data.info, currencyRate: e.target.value })} />
                                {rateLoading && <div className="absolute inset-0 flex items-center justify-center bg-white/80"><Loader size={12} className="animate-spin text-[#6B8594]"/></div>}
                            </div>
                            <span className="text-sm">TWD</span>
                        </div>
                        <div className="flex items-center justify-between gap-4">
                            <div className="flex-1 bg-[#F4F7F8] rounded-lg p-3">
                                <label className="block text-xs text-[#9DAAB0] mb-1">ç•¶åœ°é‡‘é¡</label>
                                <input type="number" className="w-full bg-transparent text-xl font-bold outline-none text-[#58707E]" value={amount} onChange={e => setAmount(e.target.value)} />
                            </div>
                            <div className="text-[#9DAAB0]">â‰ˆ</div>
                            <div className="flex-1 bg-[#E8F0F2] rounded-lg p-3">
                                <label className="block text-xs text-[#7A9E9F] mb-1">å°å¹£ (TWD)</label>
                                <div className="text-xl font-bold text-[#5A7D82]">{Math.round(amount * data.info.currencyRate).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-[#6D5D50] font-bold">è¡Œç¨‹ç­†è¨˜</h3>
                            <button onClick={handleAddNote} className="text-xs bg-[#EBE1D0] text-[#8C7654] px-3 py-1.5 rounded-full hover:bg-[#E0D4C0] flex items-center gap-1">
                                <Plus size={14}/> æ–°å¢ç­†è¨˜
                            </button>
                        </div>
                        <div className="grid grid-cols-1 gap-4">
                            {(data.info.noteCards || []).map(card => (
                                <div key={card.id} className="bg-white p-4 rounded-xl shadow-sm border border-[#EEE] relative group">
                                    <div className="flex justify-between items-center mb-2 border-b border-[#F5F5F5] pb-2">
                                        <input className="font-bold text-[#586666] bg-transparent outline-none w-full" 
                                            value={card.title} 
                                            onChange={e => {
                                                const newCards = data.info.noteCards.map(c => c.id === card.id ? { ...c, title: e.target.value } : c);
                                                updateData('info', { ...data.info, noteCards: newCards });
                                            }}
                                        />
                                        <button onClick={() => handleDeleteNote(card.id)} className="text-[#D1D1D1] hover:text-[#A67575] p-1"><Trash size={16}/></button>
                                    </div>
                                    <textarea 
                                        className="w-full resize-none outline-none text-[#586666] leading-relaxed placeholder-[#D0C0B0] text-sm min-h-[100px] bg-transparent" 
                                        placeholder="è¼¸å…¥å…§å®¹..."
                                        value={card.content} 
                                        onChange={e => updateNoteContent(card.id, e.target.value)}
                                    ></textarea>
                                </div>
                            ))}
                            {(data.info.noteCards || []).length === 0 && (
                                <div className="text-center py-8 text-[#D0C0B0] border-2 border-dashed border-[#EEE] rounded-xl">
                                    å°šç„¡ç­†è¨˜ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const PackingTab = ({ data, updateData }) => {
            const [newItems, setNewItems] = useState({});

            const handleAddItem = (category) => {
                const text = newItems[category];
                if (!text || !text.trim()) return;
                const newItem = { id: generateId(), text: text.trim(), checked: false };
                const newList = [...(data.packing[category] || []), newItem];
                updateData('packing', { ...data.packing, [category]: newList });
                setNewItems(prev => ({ ...prev, [category]: '' }));
            };

            const toggleItem = (category, itemId) => {
                const newList = data.packing[category].map(i => i.id === itemId ? { ...i, checked: !i.checked } : i);
                updateData('packing', { ...data.packing, [category]: newList });
            };
            const deleteItem = (category, itemId) => {
                const newList = data.packing[category].filter(i => i.id !== itemId);
                updateData('packing', { ...data.packing, [category]: newList });
            };

            return (
                <div className="p-4 space-y-6 pb-24">
                    {Object.entries(PACKING_CATEGORIES).map(([key, config]) => (
                        <div key={key} className="bg-white rounded-xl shadow-sm overflow-hidden border border-[#F0F0F0]">
                            <div className={`p-3 flex justify-between items-center ${config.color.split(' ')[0]}`}>
                                <h3 className={`font-bold ${config.color.split(' ')[1]}`}>{config.label}</h3>
                            </div>
                            <div className="divide-y divide-gray-100">
                                {(data.packing[key] || []).map(item => (
                                    <div key={item.id} className="flex items-center p-3 hover:bg-[#F9F9F7] group">
                                        <button onClick={() => toggleItem(key, item.id)} className={`mr-3 transition-colors ${item.checked ? 'text-[#84A59D]' : 'text-[#D1D1D1]'}`}>
                                            {item.checked ? <CheckSquare size={20} /> : <Square size={20} />}
                                        </button>
                                        <span className={`flex-1 cursor-pointer ${item.checked ? 'text-[#B0B0B0] line-through' : 'text-[#586666]'}`} onClick={() => toggleItem(key, item.id)}>{item.text}</span>
                                        <button onClick={() => deleteItem(key, item.id)} className="text-[#D1D1D1] hover:text-[#A67575] opacity-0 group-hover:opacity-100 px-2"><Trash size={16}/></button>
                                    </div>
                                ))}
                                <div className="p-2 flex items-center gap-2 border-t border-gray-50">
                                    <Plus size={18} className="text-[#D1D1D1] ml-2" />
                                    <input 
                                        type="text" 
                                        className="flex-1 bg-transparent text-sm outline-none placeholder-[#D1D1D1] text-[#586666]"
                                        placeholder="æ–°å¢é …ç›®..."
                                        value={newItems[key] || ''}
                                        onChange={e => setNewItems({ ...newItems, [key]: e.target.value })}
                                        onKeyDown={e => e.key === 'Enter' && handleAddItem(key)}
                                    />
                                    <button 
                                        onClick={() => handleAddItem(key)}
                                        disabled={!newItems[key]}
                                        className="text-xs bg-[#F0F0F0] text-[#999] px-3 py-1 rounded-full disabled:opacity-50 hover:bg-[#E0E0E0] transition-colors"
                                    >æ–°å¢</button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const ItineraryTab = ({ data, updateData, activeDayIdx, setActiveDayIdx, showModal }) => { // Pass showModal
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);
            const [editingItem, setEditingItem] = useState(null);
            const currentDay = data.days[activeDayIdx] || data.days[0];
            
            const handleUpdateItem = (itemId, updates) => {
                const newDays = [...data.days];
                const day = newDays[activeDayIdx];
                const idx = day.items.findIndex(i => i.id === itemId);
                if (idx !== -1) { day.items[idx] = { ...day.items[idx], ...updates }; updateData('days', newDays); }
            };
            const handleDeleteItem = (itemId) => {
                showModal({
                    type: 'confirm',
                    title: 'åˆªé™¤é …ç›®',
                    message: 'ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹é …ç›®å—ï¼Ÿ',
                    onConfirm: () => {
                        const newDays = [...data.days];
                        newDays[activeDayIdx].items = newDays[activeDayIdx].items.filter(i => i.id !== itemId);
                        updateData('days', newDays);
                        setEditingItem(null); // Close editing
                    }
                });
            };
            const handleAddItem = (type) => {
                const newDays = [...data.days];
                newDays[activeDayIdx].items.push({ id: generateId(), type, name: '', cost: 0, budget: 0, isShared: true, sharedAmount: 0, payer: data.travelers[0] || 'æˆ‘', location: '', note: '' });
                updateData('days', newDays);
            };
            const onDragSort = () => {
                if (dragItem.current === null || dragOverItem.current === null) return;
                const newDays = [...data.days];
                const items = [...newDays[activeDayIdx].items];
                const [moved] = items.splice(dragItem.current, 1);
                items.splice(dragOverItem.current, 0, moved);
                newDays[activeDayIdx].items = items;
                updateData('days', newDays);
                dragItem.current = null;
                dragOverItem.current = null;
            };

            const handleDayDateChange = (e) => {
                const newDate = e.target.value;
                const newDays = [...data.days];
                newDays[activeDayIdx].date = newDate;
                const currentDayId = newDays[activeDayIdx].id;
                newDays.sort((a, b) => new Date(a.date) - new Date(b.date));
                const newIndex = newDays.findIndex(d => d.id === currentDayId);
                if (newIndex !== -1) setActiveDayIdx(newIndex);
                updateData('days', newDays);
            };

            const renderTypeFields = (item) => {
                const commonInputClass = "w-full p-2 rounded border border-[#E0E0E0] text-[#586666] text-sm";
                const commonLabelClass = "text-xs text-[#9DAAB0] block mb-1";
                const currentPayer = data.travelers.includes(item.payer) ? item.payer : data.travelers[0];

                const CostBudgetBlock = () => (
                    <div className="bg-white p-3 rounded border border-[#E0E0E0] mb-3">
                        <div className="flex gap-3 mb-3">
                            <div className="flex-1">
                                <label className="text-xs text-[#9DAAB0] block mb-1">é ç®—</label>
                                <div className="relative">
                                    <span className="absolute left-2 top-2 text-[#AAA]">$</span>
                                    <input type="number" className="w-full pl-6 p-2 rounded bg-[#F9F9F7] font-bold text-[#586666]" value={item.budget || 0} onChange={e => handleUpdateItem(item.id, { budget: Number(e.target.value) })} />
                                </div>
                            </div>
                            <div className="flex-1">
                                <label className="text-xs text-[#9DAAB0] block mb-1">å¯¦éš›æ”¯å‡º</label>
                                <div className="relative">
                                    <span className="absolute left-2 top-2 text-[#AAA]">$</span>
                                    <input type="number" className="w-full pl-6 p-2 rounded bg-[#F9F9F7] font-bold text-[#586666]" 
                                        value={item.cost} 
                                        onChange={e => { 
                                            const val = Number(e.target.value); 
                                            const updates = { cost: val }; 
                                            if(item.isShared && item.sharedAmount == item.cost) { updates.sharedAmount = val; } 
                                            handleUpdateItem(item.id, updates); 
                                        }} 
                                    />
                                </div>
                            </div>
                        </div>
                        <div className="mb-3">
                            <label className="text-xs text-[#9DAAB0] block mb-1">å…ˆå¢Šä»˜äºº</label>
                            <select className="w-full p-2 rounded bg-[#F9F9F7] text-[#586666]" value={currentPayer} onChange={e=>handleUpdateItem(item.id, {payer: e.target.value})}>
                                {data.travelers.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                        </div>
                        <div className="flex items-center justify-between pt-2 border-t border-[#F0F0F0]">
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" className="w-4 h-4 text-[#84A59D] rounded accent-[#84A59D]" checked={item.isShared} onChange={e => handleUpdateItem(item.id, { isShared: e.target.checked, sharedAmount: e.target.checked ? item.cost : 0 })} />
                                <span className="text-sm font-medium text-[#777]">ç´å…¥å…¬è²»åˆ†å¸³</span>
                            </label>
                            {item.isShared && (
                                <div className="flex items-center gap-2">
                                    <span className="text-xs text-[#9DAAB0]">å…¬è²»é‡‘é¡:</span>
                                    <input type="number" className="w-20 p-1 text-right border-b border-[#84A59D] text-[#5A7D82] font-bold outline-none" value={item.sharedAmount !== undefined ? item.sharedAmount : item.cost} onChange={e => handleUpdateItem(item.id, { sharedAmount: Number(e.target.value) })} />
                                </div>
                            )}
                        </div>
                    </div>
                );

                const fields = (() => {
                    switch(item.type) {
                        case 'transport':
                        case 'flight':
                            return (
                                <>
                                    <div className="col-span-2"><label className={commonLabelClass}>{item.type==='flight'?'èˆªç­è™Ÿ':'äº¤é€šæ–¹å¼/ç­æ¬¡'}</label><input type="text" className={commonInputClass} value={item.name} onChange={e=>handleUpdateItem(item.id, {name: e.target.value})} placeholder={item.type==='flight'?'ä¾‹å¦‚: BR198':'ä¾‹å¦‚: é«˜éµ 0802è»Šæ¬¡'} /></div>
                                    <div><label className={commonLabelClass}>å‡ºç™¼åœ°</label><input type="text" className={commonInputClass} value={item.origin} onChange={e=>handleUpdateItem(item.id, {origin: e.target.value})} placeholder="èµ·é»" /></div>
                                    <div><label className={commonLabelClass}>ç›®çš„åœ°</label><input type="text" className={commonInputClass} value={item.destination} onChange={e=>handleUpdateItem(item.id, {destination: e.target.value})} placeholder="è¨–é»" /></div>
                                    <div className="col-span-2"><label className={commonLabelClass}>å‚™è¨»</label><input type="text" className={commonInputClass} value={item.note} onChange={e=>handleUpdateItem(item.id, {note: e.target.value})} placeholder="å‚™è¨»äº‹é …" /></div>
                                </>
                            );
                        case 'accommodation':
                            return (
                                <>
                                    <div className="col-span-2"><label className={commonLabelClass}>æ—…é¤¨åç¨±</label><input type="text" className={commonInputClass} value={item.name} onChange={e=>handleUpdateItem(item.id, {name: e.target.value})} placeholder="æ—…é¤¨åç¨±" /></div>
                                    <div className="col-span-2"><label className={commonLabelClass}>åœ°å€</label><input type="text" className={commonInputClass} value={item.location} onChange={e=>handleUpdateItem(item.id, {location: e.target.value})} placeholder="æ—…é¤¨åœ°å€" /></div>
                                    <div><label className={commonLabelClass}>äº¤é€šæ–¹å¼</label><input type="text" className={commonInputClass} value={item.transportMethod} onChange={e=>handleUpdateItem(item.id, {transportMethod: e.target.value})} placeholder="å¦‚ä½•æŠµé”" /></div>
                                    <div><label className={commonLabelClass}>å‚™è¨»</label><input type="text" className={commonInputClass} value={item.note} onChange={e=>handleUpdateItem(item.id, {note: e.target.value})} placeholder="å…¥ä½æ™‚é–“/è¨‚å–®è™Ÿ" /></div>
                                </>
                            );
                        case 'attraction':
                        case 'activity':
                        case 'meal':
                            return (
                                <>
                                    <div className="col-span-2"><label className={commonLabelClass}>åç¨±</label><input type="text" className={commonInputClass} value={item.name} onChange={e=>handleUpdateItem(item.id, {name: e.target.value})} placeholder="åç¨±" /></div>
                                    <div><label className={commonLabelClass}>ç‡Ÿæ¥­/æ´»å‹•æ™‚é–“</label><input type="text" className={commonInputClass} value={item.time} onChange={e=>handleUpdateItem(item.id, {time: e.target.value})} placeholder="æ™‚é–“" /></div>
                                    <div><label className={commonLabelClass}>åœ°é»</label><input type="text" className={commonInputClass} value={item.location} onChange={e=>handleUpdateItem(item.id, {location: e.target.value})} placeholder="åœ°é»" /></div>
                                    <div className="col-span-2"><label className={commonLabelClass}>å‚™è¨»</label><input type="text" className={commonInputClass} value={item.note} onChange={e=>handleUpdateItem(item.id, {note: e.target.value})} placeholder="å‚™è¨»" /></div>
                                </>
                            );
                        default:
                            return (
                                <>
                                    <div className="col-span-2"><label className={commonLabelClass}>é …ç›®åç¨±</label><input type="text" className={commonInputClass} value={item.name} onChange={e=>handleUpdateItem(item.id, {name: e.target.value})} placeholder="åç¨±" /></div>
                                    <div className="col-span-2"><label className={commonLabelClass}>å‚™è¨»</label><input type="text" className={commonInputClass} value={item.note} onChange={e=>handleUpdateItem(item.id, {note: e.target.value})} placeholder="å‚™è¨»" /></div>
                                </>
                            );
                    }
                })();

                return (
                    <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-3">
                            {fields}
                        </div>
                        <CostBudgetBlock /> 
                    </div>
                );
            };

            const renderCardContent = (item) => {
                const subTextClass = "text-xs text-[#9DAAB0] truncate mr-2";
                switch(item.type) {
                    case 'transport':
                    case 'flight':
                        return (
                            <div className="flex flex-wrap">
                                {item.origin && item.destination && <span className={subTextClass}>{item.origin} â {item.destination}</span>}
                                {item.note && <span className={subTextClass}>ğŸ“ {item.note}</span>}
                            </div>
                        );
                    case 'accommodation':
                        return (
                            <div className="flex flex-col">
                                {item.location && <span className={subTextClass}>ğŸ“ {item.location}</span>}
                                {item.transportMethod && <span className={subTextClass}>ğŸš‡ {item.transportMethod}</span>}
                                {item.note && <span className={subTextClass}>ğŸ“ {item.note}</span>}
                            </div>
                        );
                    case 'attraction':
                    case 'activity':
                    case 'meal':
                         return (
                            <div className="flex flex-wrap">
                                {item.time && <span className={subTextClass}>ğŸ•’ {item.time}</span>}
                                {item.location && <span className={subTextClass}>ğŸ“ {item.location}</span>}
                                {item.note && <span className={subTextClass}>ğŸ“ {item.note}</span>}
                            </div>
                        );
                    default:
                         return item.note && <span className={subTextClass}>ğŸ“ {item.note}</span>;
                }
            };

            return (
                <div className="flex flex-col h-full">
                    {/* æ—¥æœŸé¸æ“‡å™¨ */}
                    <div className="bg-white border-b border-[#EEE] overflow-x-auto scrollbar-hide sticky top-0 z-10 shadow-sm">
                        <div className="flex px-2 w-max">
                            {data.days.map((day, idx) => (
                                <button key={day.id} onClick={() => setActiveDayIdx(idx)} className={`px-5 py-3 text-center border-b-2 transition-colors ${activeDayIdx === idx ? 'border-[#84A59D] bg-[#F4F8F7]' : 'border-transparent'}`}>
                                    <div className={`text-xs ${activeDayIdx === idx ? 'text-[#84A59D] font-bold' : 'text-[#B0B0B0]'}`}>Day {idx + 1}</div>
                                    <div className={`text-sm ${activeDayIdx === idx ? 'text-[#5A7D82] font-bold' : 'text-[#888]'}`}>{day.date.slice(5)}</div>
                                </button>
                            ))}
                            <button onClick={() => { const newDays = [...data.days]; const lastDate = newDays[newDays.length-1].date; newDays.push({id: generateId(), date: addDays(lastDate, 1), items: []}); updateData('days', newDays); }} className="px-4 text-[#B0B0B0] hover:text-[#84A59D]"><Plus size={20}/></button>
                        </div>
                    </div>
                    
                    <div className="p-4 space-y-3 pb-32">
                        {/* å–®æ—¥æ—¥æœŸç·¨è¼¯å€ */}
                        <div className="flex items-center gap-2 mb-2 bg-white p-3 rounded-xl border border-[#F0F0F0] shadow-sm">
                            <span className="text-sm font-bold text-[#5A7D82] whitespace-nowrap">Day {activeDayIdx + 1} æ—¥æœŸï¼š</span>
                            <input 
                                type="date" 
                                className="bg-transparent text-[#586666] outline-none border-b border-[#E0E0E0] focus:border-[#84A59D] w-full text-sm font-mono"
                                value={currentDay.date}
                                onChange={handleDayDateChange}
                            />
                        </div>

                        {currentDay.items.map((item, index) => {
                            const isEditing = editingItem === item.id;
                            const typeConfig = ITEM_TYPES[item.type] || ITEM_TYPES.other;
                            const TypeIcon = typeConfig.icon;
                            const displaySharedAmount = item.sharedAmount !== undefined ? item.sharedAmount : item.cost;
                            
                            return (
                                <div key={item.id} draggable={!isEditing} onDragStart={() => dragItem.current = index} onDragEnter={() => dragOverItem.current = index} onDragEnd={onDragSort} onDragOver={e => e.preventDefault()} className={`bg-white rounded-xl shadow-sm border border-[#F0F0F0] overflow-hidden transition-all ${isEditing ? 'ring-2 ring-[#84A59D]' : ''}`}>
                                    {!isEditing ? (
                                        <div className="flex items-center p-3 gap-3" onClick={() => setEditingItem(item.id)}>
                                            <div className="cursor-move text-[#D1D1D1]"><Grip size={16}/></div>
                                            <div className={`p-2 rounded-lg ${typeConfig.color}`}><TypeIcon size={18}/></div>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-bold text-[#586666] truncate">{item.name || "æœªå‘½åé …ç›®"}</div>
                                                {renderCardContent(item)}
                                                <div className="text-xs text-[#9DAAB0] flex gap-2 mt-1">
                                                    {item.budget > 0 && <span className="bg-[#F0F0F0] px-1 rounded text-[#999]">é  ${item.budget}</span>}
                                                    {item.cost > 0 && <span className="bg-[#F4F4F4] px-1 rounded text-[#777]">å¯¦ ${item.cost}</span>}
                                                    {item.payer && <span className="bg-[#EBE1D0] bg-opacity-40 px-1 rounded text-[#8C7654]">{item.payer}</span>}
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                 {item.cost > 0 && (<div className="text-xs font-bold text-[#AAA]">{item.isShared ? (<span className="text-[#84A59D] flex items-center justify-end gap-1"><Users size={10}/> å…¬è²» ${displaySharedAmount}</span>) : (<span className="text-[#B0B0B0]">å€‹äºº</span>)}</div>)}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="p-4 bg-[#F9F9F7]">
                                            <div className="flex justify-between items-center mb-3 pb-2 border-b border-[#E0E0E0]"><span className="text-xs font-bold text-[#AAA] uppercase">ç·¨è¼¯é …ç›®</span><div className="flex gap-2"><button onClick={()=>handleDeleteItem(item.id)} className="text-[#A67575] p-1"><Trash size={16}/></button><button onClick={()=>setEditingItem(null)} className="text-[#5A7D82] font-bold px-3 py-1 bg-[#D0E0E3] rounded text-sm">å®Œæˆ</button></div></div>
                                            {renderTypeFields(item)}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                        <div className="grid grid-cols-6 gap-2 pt-2">{Object.entries(ITEM_TYPES).filter(([type]) => type !== 'flight').map(([type, config]) => { const Icon = config.icon; return <button key={type} onClick={() => handleAddItem(type)} className="flex flex-col items-center justify-center p-2 rounded-lg bg-white border border-[#EEE] active:scale-95 transition-transform hover:bg-[#F9F9F7]"><div className={`p-2 rounded-full mb-1 ${config.color}`}><Icon size={18} /></div><span className="text-[10px] text-[#888] truncate">{config.label}</span></button>})}</div>
                    </div>
                </div>
            );
        };

        const ExpensesTab = ({ data }) => {
            const summary = useMemo(() => {
                const balances = {}; 
                const travelerList = data.travelers || [];
                const personalPrivateSpend = {}; 

                travelerList.forEach(t => {
                    balances[t] = { paidForPublic: 0, paidTotal: 0, shouldPay: 0, diff: 0 };
                    personalPrivateSpend[t] = 0;
                });
                
                let totalPublicExpense = 0;
                let totalPublicBudget = 0;
                
                const allItems = data.days.flatMap(d => d.items).filter(i => i.cost > 0 || i.budget > 0);
                
                allItems.forEach(item => {
                    const payer = travelerList.includes(item.payer) ? item.payer : travelerList[0];
                    const cost = Number(item.cost) || 0;
                    const budget = Number(item.budget) || 0;

                    if (item.isShared) {
                        totalPublicBudget += budget; 
                        const sharedAmt = item.sharedAmount !== undefined ? item.sharedAmount : cost;
                        totalPublicExpense += sharedAmt;
                        if (balances[payer]) {
                            balances[payer].paidForPublic += sharedAmt;
                            balances[payer].paidTotal += cost; 
                        }
                    } else {
                        if (balances[payer]) {
                            balances[payer].paidTotal += cost;
                        }
                        if (personalPrivateSpend[payer] !== undefined) {
                            personalPrivateSpend[payer] += cost;
                        }
                    }
                });

                const perPersonShare = totalPublicExpense / (travelerList.length || 1);

                travelerList.forEach(t => {
                    balances[t].shouldPay = perPersonShare;
                    balances[t].diff = balances[t].paidForPublic - perPersonShare; 
                });

                const itemsByPayer = {};
                travelerList.forEach(t => itemsByPayer[t] = []);
                allItems.forEach(item => { 
                    const payer = travelerList.includes(item.payer) ? item.payer : travelerList[0];
                    if(itemsByPayer[payer]) itemsByPayer[payer].push(item); 
                });

                return { totalPublicExpense, totalPublicBudget, perPersonShare, balances, personalPrivateSpend, itemsByPayer };
            }, [data]);

            const budgetPercent = summary.totalPublicBudget > 0 
                ? Math.min((summary.totalPublicExpense / summary.totalPublicBudget) * 100, 100) 
                : 0;

            return (
                <div className="p-4 pb-24 space-y-6">
                    {/* ç½®é ‚å…¬è²» Bar */}
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-[#F0F0F0]">
                        <div className="flex justify-between items-end mb-2">
                            <div>
                                <h2 className="text-[#586666] font-bold text-lg">å…¬è²»æ¦‚æ³</h2>
                                <span className="text-xs text-[#9DAAB0]">ç¸½é ç®— ${summary.totalPublicBudget.toLocaleString()}</span>
                            </div>
                            <div className="text-right">
                                <div className="text-2xl font-bold text-[#84A59D]">${summary.totalPublicExpense.toLocaleString()}</div>
                                <span className="text-xs text-[#9DAAB0]">å¯¦éš›æ”¯å‡º</span>
                            </div>
                        </div>
                        <div className="w-full bg-[#F0F0F0] rounded-full h-3 overflow-hidden">
                            <div 
                                className={`h-full rounded-full transition-all duration-500 ${summary.totalPublicExpense > summary.totalPublicBudget ? 'bg-[#A67575]' : 'bg-[#84A59D]'}`} 
                                style={{ width: `${budgetPercent}%` }}
                            ></div>
                        </div>
                        <div className="mt-2 text-center">
                             <span className="inline-block bg-[#F4F8F7] px-3 py-1 rounded-full text-xs text-[#5A7D82]">
                                æ¯äººæ‡‰åˆ†æ”¤å…¬è²» <span className="font-bold">${Math.round(summary.perPersonShare).toLocaleString()}</span>
                            </span>
                        </div>
                    </div>
                    
                    {/* ğŸŸ¢ å€‹äººè²¡å‹™å¡ç‰‡ (åˆä½µç‰ˆ) */}
                    <div className="space-y-4">
                        {data.travelers.map(t => {
                            const publicShare = Math.round(summary.perPersonShare);
                            const privateSpend = Math.round(summary.personalPrivateSpend[t] || 0);
                            const totalCost = publicShare + privateSpend;
                            const info = summary.balances[t] || { paidForPublic: 0, shouldPay: 0, diff: 0 };
                            const diff = Math.round(info.diff);

                            return (
                                <div key={t} className="bg-white rounded-xl shadow-sm border border-[#F0F0F0] p-4">
                                    <div className="flex items-center gap-2 mb-3 border-b border-[#F9F9F7] pb-2">
                                        <div className="w-8 h-8 rounded-full bg-[#F4F8F7] flex items-center justify-center text-xs font-bold text-[#5A7D82]">{t[0]}</div>
                                        <span className="font-bold text-[#586666] text-lg">{t}</span>
                                    </div>
                                    
                                    <div className="mb-3">
                                        <div className="flex justify-between items-center mb-1">
                                            <h4 className="text-sm font-bold text-[#6B8E8E]">å€‹äººç¸½æ”¯å‡º</h4>
                                            <span className="font-bold text-[#586666] text-lg">${totalCost.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between text-[11px] text-[#9DAAB0] bg-[#FDFBF7] p-2 rounded">
                                            <span>æ‡‰ä»˜å…¬è²»: ${publicShare.toLocaleString()}</span>
                                            <span>+</span>
                                            <span>å€‹äººç§è²»: ${privateSpend.toLocaleString()}</span>
                                        </div>
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-1">
                                            <h4 className="text-sm font-bold text-[#84A59D]">å…¬è²»çµç®—å»ºè­°</h4>
                                            <div className="text-right">
                                                {diff > 0 ? (
                                                    <span className="text-[#84A59D] font-bold">æ‡‰æ”¶ ${diff.toLocaleString()}</span>
                                                ) : diff < 0 ? (
                                                    <span className="text-[#A67575] font-bold">æ‡‰ä»˜ ${Math.abs(diff).toLocaleString()}</span>
                                                ) : (
                                                    <span className="text-[#B0B0B0]">å¹³</span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="text-right text-[10px] text-[#9DAAB0]">
                                            å·²ä»£å¢Šå…¬è²»: ${Math.round(info.paidForPublic).toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div className="space-y-4 pt-4 border-t border-[#F0F0F0]">
                        <h3 className="text-sm font-bold text-[#9DAAB0] pl-1">è©³ç´°æ”¯ä»˜ç´€éŒ„</h3>
                        {data.travelers.map(payer => {
                            const items = summary.itemsByPayer[payer];
                            if(!items || items.length === 0) return null;
                            const totalPaid = summary.balances[payer]?.paidTotal || 0;
                            return (
                                <div key={payer} className="bg-white rounded-xl shadow-sm border border-[#F0F0F0] overflow-hidden">
                                    <div className="bg-[#F9F9F7] p-3 flex justify-between items-center"><span className="font-bold text-[#586666]">{payer} çš„æ”¯ä»˜ç´€éŒ„</span><span className="text-xs bg-[#E0E0E0] px-2 py-1 rounded text-[#777]">å…± {items.length} ç­†</span></div>
                                    <div className="divide-y divide-[#F9F9F7]">
                                        {items.map(item => {
                                            const sharedVal = item.sharedAmount !== undefined ? item.sharedAmount : item.cost;
                                            return (
                                                <div key={item.id} className="p-3 flex justify-between items-center text-sm">
                                                    <div><div className="font-medium text-[#586666]">{item.name || "æœªå‘½å"}</div><div className="text-xs text-[#9DAAB0]">Day {data.days.findIndex(d=>d.items.includes(item))+1}</div></div>
                                                    <div className="text-right"><div className="font-bold text-[#586666]">${item.cost}</div>{item.isShared ? (<div className="text-[10px] text-[#84A59D]">å…¬è²»: ${sharedVal}</div>) : (<div className="text-[10px] text-[#D1D1D1]">å€‹äººæ”¯å‡º</div>)}</div>
                                                </div>
                                            );
                                        })}
                                        <div className="p-2 bg-[#FDFBF7] text-right text-xs text-[#9DAAB0]">
                                            å€‹äººä»£å¢Šç¸½é¡ (å«ç§è²»): <span className="font-bold text-[#586666]">${totalPaid.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- ä¸»æ‡‰ç”¨ç¨‹å¼ (App) ---
        function App() {
            const [tripId, setTripId] = useState("");
            const [tripData, setTripData] = useState(INITIAL_DATA);
            const [activeTab, setActiveTab] = useState("itinerary");
            const [activeDayIdx, setActiveDayIdx] = useState(0);
            const [syncState, setSyncState] = useState(isOnline ? 'connecting' : 'offline'); 
            // ğŸŸ¢ æ–°å¢ Modal State
            const [modal, setModal] = useState({ isOpen: false, type: 'input', title: '', message: '', defaultValue: '', onConfirm: null });

            // ğŸŸ¢ Helper to show modal
            const showModal = (config) => {
                setModal({ isOpen: true, ...config });
            };
            const closeModal = () => {
                setModal(prev => ({ ...prev, isOpen: false }));
            };

            // ... (rest of effects: ID init, Firebase, AutoSave)
            useEffect(() => {
                let tId = "";
                try {
                    const params = new URLSearchParams(window.location.search);
                    tId = params.get('tripId');
                } catch (e) {}
                
                if(!tId) {
                    tId = generateId().toUpperCase();
                    try {
                        if (window.history && window.history.replaceState) {
                            window.history.replaceState(null, '', `?tripId=${tId}`);
                        }
                    } catch (e) {}
                }
                setTripId(tId);
            }, []);

            useEffect(() => {
                if (!isOnline || !tripId || !db) {
                    setSyncState('offline');
                    return;
                }
                auth.signInAnonymously().then(() => {
                    const unsub = db.collection('trips').doc(tripId).onSnapshot(doc => {
                        if(doc.exists) {
                            const data = doc.data();
                            setTripData(prev => ({
                                ...INITIAL_DATA,
                                ...data,
                                info: { ...INITIAL_DATA.info, ...(data.info || {}) },
                                packing: { ...INITIAL_DATA.packing, ...(data.packing || {}) }
                            }));
                        }
                        setSyncState('synced');
                    }, () => setSyncState('error'));
                    return () => unsub();
                }).catch(() => setSyncState('error'));
            }, [tripId]);

            useEffect(() => {
                if(syncState !== 'synced' || !tripId) return;
                const timer = setTimeout(() => {
                    setSyncState('connecting');
                    db.collection('trips').doc(tripId).set(tripData)
                        .then(() => setSyncState('synced'))
                        .catch(() => setSyncState('error'));
                }, 1000);
                return () => clearTimeout(timer);
            }, [tripData, tripId]);

            const updateData = (key, value) => setTripData(prev => ({ ...prev, [key]: value }));
            
            // ğŸŸ¢ æ›¿æ›åŸç”ŸåŠŸèƒ½ - åˆ†äº«
            const shareLink = () => {
                const url = window.location.href;
                // å˜—è©¦å¯«å…¥ Clipboard (è‹¥æ”¯æ´)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(url).then(() => {
                        // Show simple toast or modal
                        showModal({ type: 'alert', title: 'å·²è¤‡è£½é€£çµ', message: 'é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œå‚³é€çµ¦æ—…ä¼´å³å¯åŒæ­¥ç·¨è¼¯ï¼', showCancel: false });
                    }).catch(() => {
                        // Fallback
                        showModal({ type: 'input', title: 'æ‰‹å‹•è¤‡è£½é€£çµ', message: 'è«‹è¤‡è£½ä¸‹æ–¹é€£çµå‚³é€çµ¦æ—…ä¼´ï¼š', defaultValue: url, showCancel: false });
                    });
                } else {
                    // Fallback for older browsers / strict sandbox
                    const textArea = document.createElement("textarea");
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showModal({ type: 'alert', title: 'å·²è¤‡è£½é€£çµ', message: 'é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', showCancel: false });
                    } catch (err) {
                        showModal({ type: 'input', title: 'æ‰‹å‹•è¤‡è£½é€£çµ', message: 'è«‹è¤‡è£½ä¸‹æ–¹é€£çµå‚³é€çµ¦æ—…ä¼´ï¼š', defaultValue: url, showCancel: false });
                    }
                    document.body.removeChild(textArea);
                }
            };

            // ğŸŸ¢ æ›¿æ›åŸç”ŸåŠŸèƒ½ - åˆ‡æ› Trip
            const switchTrip = () => {
                showModal({
                    type: 'input',
                    title: 'åˆ‡æ›è¡Œç¨‹',
                    message: 'è«‹è¼¸å…¥æ–°çš„è¡Œç¨‹ ID (è‹±æ•¸å­—) ä»¥åˆ‡æ›æˆ–å»ºç«‹æ–°è¡Œç¨‹ï¼š',
                    defaultValue: tripId,
                    onConfirm: (newId) => {
                        if (newId && newId !== tripId) {
                            const safeId = newId.trim().replace(/[^a-zA-Z0-9\-_]/g, '');
                            if (safeId) {
                                try {
                                    const url = new URL(window.location.href);
                                    url.searchParams.set('tripId', safeId);
                                    window.location.href = url.toString();
                                } catch (e) {
                                    showModal({ type: 'input', title: 'æ‰‹å‹•åˆ‡æ›', message: 'è«‹è¤‡è£½æ–°ç¶²å€ï¼š', defaultValue: window.location.pathname + '?tripId=' + safeId, showCancel: false });
                                }
                            } else {
                                showModal({ type: 'alert', title: 'æ ¼å¼éŒ¯èª¤', message: 'ID åªèƒ½åŒ…å«è‹±æ•¸å­—ã€åº•ç·šæˆ–æ¸›è™Ÿ', showCancel: false });
                            }
                        }
                    }
                });
            };

            // ğŸŸ¢ æ›¿æ›åŸç”ŸåŠŸèƒ½ - ç·¨è¼¯æ¨™é¡Œ
            const editTitle = () => {
                showModal({
                    type: 'input',
                    title: 'ä¿®æ”¹æ¨™é¡Œ',
                    defaultValue: tripData.title,
                    onConfirm: (val) => val && updateData('title', val)
                });
            };

            // ğŸŸ¢ æ›¿æ›åŸç”ŸåŠŸèƒ½ - ç·¨è¼¯æ—…ä¼´
            const editTravelers = () => {
                showModal({
                    type: 'input',
                    title: 'ä¿®æ”¹æ—…ä¼´åå–®',
                    message: 'è«‹è¼¸å…¥æ—…ä¼´å§“å (ç”¨é€—è™Ÿåˆ†éš”)ï¼š',
                    defaultValue: tripData.travelers.join(','),
                    onConfirm: (val) => {
                        if(val) updateData('travelers', val.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s));
                    }
                });
            };

            const handleStartDateChange = (newStartDate) => {
                if (!newStartDate) return;
                const newDays = tripData.days.map((day, index) => ({ ...day, date: addDays(newStartDate, index) }));
                setTripData(prev => ({ ...prev, startDate: newStartDate, days: newDays }));
            };

            // ğŸŸ¢ Modal å…§éƒ¨çµ„ä»¶æ¸²æŸ“é‚è¼¯
            const ModalContent = () => {
                const [inputVal, setInputVal] = useState(modal.defaultValue || '');
                useEffect(() => setInputVal(modal.defaultValue || ''), [modal.isOpen, modal.defaultValue]);

                return (
                    <Modal 
                        isOpen={modal.isOpen} 
                        onClose={closeModal} 
                        title={modal.title} 
                        showConfirm={modal.type !== 'alert'} // Alert only shows "Close" (handled by x) or we can make custom
                        showCancel={modal.type !== 'alert'}
                        onConfirm={() => {
                            if (modal.onConfirm) modal.onConfirm(modal.type === 'input' ? inputVal : undefined);
                            closeModal();
                        }}
                    >
                        {modal.message && <p className="text-sm text-[#586666] mb-3">{modal.message}</p>}
                        {modal.type === 'input' && (
                            <input 
                                type="text" 
                                className="w-full border border-[#E0E0E0] rounded p-2 text-[#586666] focus:border-[#84A59D] outline-none" 
                                value={inputVal} 
                                onChange={e => setInputVal(e.target.value)} 
                                autoFocus
                            />
                        )}
                        {modal.type === 'alert' && <div className="flex justify-end"><button onClick={closeModal} className="px-4 py-2 bg-[#84A59D] text-white rounded text-sm">é—œé–‰</button></div>}
                    </Modal>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#FDFBF7] flex flex-col relative shadow-2xl shadow-[#DCE5E8]/30">
                    <ModalContent />
                    
                    <header className="bg-white px-4 py-3 shadow-sm sticky top-0 z-20 flex justify-between items-center border-b border-[#F0F0F0]">
                        <div className="flex flex-col">
                            <h1 className="font-bold text-lg text-[#5A7D82] flex items-center gap-2">
                                <span onClick={editTitle} className="cursor-pointer hover:underline decoration-dashed decoration-[#84A59D] underline-offset-4">{tripData.title}</span>
                                <span 
                                    onClick={switchTrip}
                                    className="text-[10px] bg-[#D0E0E3] text-[#5A7D82] px-1.5 py-0.5 rounded font-mono cursor-pointer hover:bg-[#BCCCD1]"
                                    title="é»æ“Šåˆ‡æ›æˆ–å»ºç«‹æ–°è¡Œç¨‹"
                                >
                                    ID: {tripId} âœ
                                </span>
                            </h1>
                            <div className="flex items-center gap-2">
                                <label className="flex items-center gap-1 cursor-pointer hover:bg-[#F9F9F7] px-1 rounded transition-colors">
                                    <input 
                                        type="date" 
                                        value={tripData.startDate} 
                                        onChange={(e) => handleStartDateChange(e.target.value)}
                                        className="text-xs text-[#9DAAB0] bg-transparent outline-none w-[80px] cursor-pointer"
                                    />
                                    <span className="text-xs text-[#9DAAB0]">å‡ºç™¼ &middot; {tripData.days.length} å¤©</span>
                                </label>

                                {syncState === 'synced' && <span className="text-[10px] text-[#84A59D] flex items-center"><Wifi size={10} className="mr-1"/>å·²åŒæ­¥</span>}
                                {syncState === 'connecting' && <span className="text-[10px] text-[#EBE1D0] flex items-center"><Loader size={10} className="mr-1 animate-spin"/>åŒæ­¥ä¸­</span>}
                                {(syncState === 'offline' || syncState === 'error') && <span className="text-[10px] text-[#D1D1D1] flex items-center"><WifiOff size={10} className="mr-1"/>é›¢ç·šæ¨¡å¼</span>}
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={editTravelers} className="p-2 bg-[#F9F9F7] rounded-full text-[#9DAAB0] hover:bg-[#F4F8F7] hover:text-[#5A7D82]"><Users size={18}/></button>
                            <button onClick={shareLink} className="p-2 bg-[#D0E0E3] rounded-full text-[#5A7D82] hover:bg-[#84A59D] hover:text-white"><Share size={18}/></button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-y-auto">
                        {activeTab === 'info' && <InfoTab data={tripData} updateData={updateData} showModal={showModal} />}
                        {activeTab === 'packing' && <PackingTab data={tripData} updateData={updateData} />}
                        {activeTab === 'itinerary' && <ItineraryTab data={tripData} updateData={updateData} activeDayIdx={activeDayIdx} setActiveDayIdx={setActiveDayIdx} showModal={showModal} />}
                        {activeTab === 'expenses' && <ExpensesTab data={tripData} />}
                    </main>
                    <nav className="bg-white border-t border-[#F0F0F0] fixed bottom-0 left-0 right-0 max-w-md mx-auto pb-safe z-30">
                        <div className="flex justify-around items-center h-16">
                            {[{ id: 'info', icon: Home, label: 'ä»‹ç´¹' }, { id: 'packing', icon: Briefcase, label: 'è¡Œæ' }, { id: 'itinerary', icon: MapIcon, label: 'è¡Œç¨‹' }, { id: 'expenses', icon: DollarSign, label: 'å¸³å‹™' }].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${activeTab === tab.id ? 'text-[#6B8E8E]' : 'text-[#D1D1D1]'}`}><tab.icon size={24} strokeWidth={activeTab === tab.id ? 2.5 : 2} /><span className="text-[10px] font-medium">{tab.label}</span></button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
